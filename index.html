<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heymarket Campaign Analysis Tool</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .upload-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
    }

    .upload-section.fade-out {
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }

    .upload-section.fade-in {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.4s ease forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 10px;
      padding: 40px;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #f8f9ff;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-area.dragover {
      border-color: #764ba2;
      background: #e8ebff;
    }

    .upload-icon {
      font-size: 3rem;
      color: #667eea;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 10px;
    }

    .upload-subtext {
      color: #999;
      font-size: 0.9rem;
    }

    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin: 10px 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .analysis-section {
      display: none;
      background: white;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .section-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .section-content {
      padding: 25px;
    }

    .stats-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .stats-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th,
    .stats-table td {
      padding: 15px 20px;
      text-align: left;
      border-bottom: 1px solid #e1e5f2;
    }

    .stats-table th {
      background: #f8f9ff;
      font-weight: 600;
      color: #667eea;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }

    .stats-table td {
      color: #333;
    }

    .stats-table .number-cell {
      text-align: right;
      font-weight: 600;
      color: #667eea;
      font-size: 1.1rem;
    }

    .stats-table .total-row {
      background: #f0f2ff;
      font-weight: 700;
      border-top: 2px solid #667eea;
    }

    .stats-table .total-row td {
      color: #667eea;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8f9ff;
      border: 2px solid #e1e5f2;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .brand-section {
      margin-bottom: 20px;
      border: 1px solid #e1e5f2;
      border-radius: 10px;
      overflow: hidden;
    }

    .brand-header {
      background: #f8f9ff;
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .brand-header:hover {
      background: #f0f2ff;
    }

    .brand-name {
      font-weight: 600;
      font-size: 1.1rem;
      color: #667eea;
    }

    .brand-count {
      background: #667eea;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .brand-content {
      display: none;
      padding: 20px;
      background: #fafbff;
    }

    .record-item {
      background: white;
      border: 1px solid #e1e5f2;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .record-header {
      padding: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
    }

    .record-header:hover {
      background: #f8f9ff;
    }

    .record-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .record-name {
      font-weight: 600;
      color: #333;
    }

    .record-phone {
      color: #666;
      font-family: monospace;
    }

    .record-time {
      color: #999;
      font-size: 0.9rem;
    }

    .record-messages {
      display: none;
      padding: 20px;
      background: #f8f9ff;
      border-top: 1px solid #e1e5f2;
    }

    .message {
      background: white;
      border-radius: 8px;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .message.outgoing {
      border-left-color: #764ba2;
      background: #f0f2ff;
    }

    .message.incoming {
      border-left-color: #52c41a;
      background: #f6ffed;
    }

    .message-text {
      line-height: 1.5;
      word-wrap: break-word;
    }

    .toggle-icon {
      transition: transform 0.3s ease;
    }

    .toggle-icon.rotated {
      transform: rotate(180deg);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .control-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-btn {
      background: linear-gradient(135deg, #52c41a, #389e0d);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .control-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .control-btn.collapse {
      background: linear-gradient(135deg, #ff7875, #ff4d4f);
    }

    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .hidden {
      display: none;
    }

    /* Google Sign-In button centering */
    #googleSignInButton {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 15px auto;
    }

    /* Target the actual Google button iframe */
    #googleSignInButton iframe {
      margin: 0 auto;
    }

    /* Target the Google button div */
    #googleSignInButton > div {
      margin: 0 auto;
    }

    /* jQuery UI Datepicker custom styles */
    .available-date a {
      background-color: #e8f5e8 !important;
      border-color: #4caf50 !important;
      color: #2e7d32 !important;
      font-weight: bold !important;
    }
    
    .available-date a:hover {
      background-color: #c8e6c9 !important;
    }
    
    .unavailable-date a {
      background-color: #ffebee !important;
      border-color: #f44336 !important;
      color: #c62828 !important;
      text-decoration: line-through !important;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .record-info {
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 Campaign Analysis</h1>
      <p>View reports directly from Google Sheets</p>
    </div>

    <div class="upload-section">
      <div class="upload-area" id="authArea">
        <div class="upload-icon">🔐</div>
        <div class="upload-text">Sign in with Google to Access Sheets Data</div>
        <div class="upload-subtext">Secure OAuth authentication for Heymarket campaign reports</div>
        <div id="googleSignInButton"></div>
        <div id="userProfile" class="hidden" style="margin-top: 15px;">
          <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <img id="userPhoto" style="width: 40px; height: 40px; border-radius: 50%;" alt="User profile">
            <div>
              <div id="userName" style="font-weight: 600; color: #333;"></div>
              <div id="userEmail" style="color: #666; font-size: 0.9rem;"></div>
            </div>
          </div>
          <button class="btn" onclick="verifyAccess()" style="margin-top: 10px;">Access Data</button>
          <button class="btn" onclick="signOut()" style="background: #f5222d; margin-top: 10px;">Sign Out</button>
        </div>
      </div>
    </div>

    <!-- Step 2: After password verified -->
    <div id="dateSelector" class="upload-section hidden">
      <div style="text-align: center;">
        <h3 style="margin-bottom: 20px; color: #667eea;">Select Campaign Date</h3>
                 <div style="margin-bottom: 15px;">
           <label for="dateInput" style="display: block; margin-bottom: 5px; font-weight: 600;">Choose Date:</label>
           <input type="text" id="dateInput" readonly placeholder="Click to select date" aria-label="Select campaign date to view analysis" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 200px; cursor: pointer; background: white;">
           <div id="dateInfo" style="color: #667eea; font-size: 0.9rem; margin-top: 5px;">
             Available dates: <span id="availableDatesText">Loading...</span>
           </div>
         </div>
      </div>
    </div>

    <div id="loadingSection" class="analysis-section">
      <div class="loading">
        <div class="spinner"></div>
        <div>Processing your data...</div>
      </div>
    </div>

    <div id="noResponseSection" class="analysis-section">
      <div class="section-header">
        📈 No Response Tallies by Brand
      </div>
      <div class="section-content">
        <div id="noResponseStats" class="stats-table">
          <!-- No response statistics will be populated here -->
        </div>
      </div>
    </div>

    <div id="responseSection" class="analysis-section">
      <div class="section-header">
        💬 Response Analysis by Brand - <span id="totalResponsesCount">0 Total Responses</span>
      </div>
      <div class="section-content">
        <div id="stopResponsesStats" class="stats-grid" style="margin-bottom: 25px;">
          <!-- STOP response statistics will be populated here -->
        </div>
        <div class="control-buttons">
          <button class="control-btn" onclick="expandAllBrands()">Expand All Brands</button>
          <button class="control-btn collapse" onclick="collapseAllBrands()">Collapse All Brands</button>
          <button class="control-btn" onclick="expandAllRecords()">Expand All Conversations</button>
          <button class="control-btn collapse" onclick="collapseAllRecords()">Collapse All Conversations</button>
        </div>
        <div id="responseBrands">
          <!-- Brand sections will be populated here -->
        </div>
      </div>
    </div>

    <!-- Where general results/messages show -->
    <div id="result"></div>
  </div>

  <script>
    const Google_Script_ID = "AKfycbzfOem8exv5LUzaHPHjBbizCFEl4Mx700YLg4XgWwIqsOP1BwUMvyxdim2w2iEdMvYF"; // Replace with your NEW deployment ID
    const scriptUrl = "https://script.google.com/macros/s/" + Google_Script_ID + "/exec";
    
    // Replace with your Google Cloud Project OAuth Client ID
    const GOOGLE_CLIENT_ID = "221842260905-nidbveovs3vjft1oc42rf4a3aeamdafo.apps.googleusercontent.com";

    let userCredential = null;
    let availableSheets = [];
    let availableDates = [];
    let rawData = [];
    let processedData = {
      noResponse: {},
      responses: {},
      stopResponses: {}
    };

    // Check if this is a userscript authentication request
    function checkUserscriptAuth() {
      const urlParams = new URLSearchParams(window.location.search);
      const isUserscriptAuth = urlParams.get('userscript_auth');
      const state = urlParams.get('state');
      const returnUrl = urlParams.get('return_url');
      
      if (isUserscriptAuth === 'true' && state && returnUrl) {
        console.log('🔄 Userscript authentication detected');
        
        // Store auth params for after OAuth completion
        sessionStorage.setItem('userscript_auth_state', state);
        sessionStorage.setItem('userscript_return_url', decodeURIComponent(returnUrl));
        
        // Show special message for userscript users
        document.body.innerHTML = `
          <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h2>🔐 Authenticating Userscript</h2>
            <p>Please sign in with Google to authenticate your Heymarket userscript.</p>
            <p>After signing in, you'll be automatically redirected back to Heymarket.</p>
            <div id="googleSignInButton" style="margin: 20px auto; display: inline-block;"></div>
          </div>
        `;
        
        return true;
      }
      
      return false;
    }

    // Handle successful OAuth for userscript flow
    function handleUserscriptAuthSuccess(token) {
      const state = sessionStorage.getItem('userscript_auth_state');
      const returnUrl = sessionStorage.getItem('userscript_return_url');
      
      if (state && returnUrl) {
        console.log('✅ Redirecting back to userscript with token');
        
        // Clean up session storage
        sessionStorage.removeItem('userscript_auth_state');
        sessionStorage.removeItem('userscript_return_url');
        
        // Build return URL with token
        const redirectUrl = new URL(returnUrl);
        redirectUrl.searchParams.append('userscript_auth_return', 'true');
        redirectUrl.searchParams.append('token', token);
        redirectUrl.searchParams.append('state', state);
        
        // Redirect back to Heymarket
        window.location.href = redirectUrl.toString();
        return true;
      }
      
      return false;
    }

    // Initialize Google Sign-In when page loads
    window.onload = function() {
      // Check if this is a userscript auth request first
      const isUserscriptAuth = checkUserscriptAuth();
      
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: function(response) {
          // Check if this is for userscript auth
          if (isUserscriptAuth && handleUserscriptAuthSuccess(response.credential)) {
            return; // Redirecting to userscript, don't process normal flow
          }
          
          // Normal web app flow
          handleSignInResponse(response);
        },
        auto_select: false,
        cancel_on_tap_outside: false
      });
      
      google.accounts.id.renderButton(
        document.getElementById("googleSignInButton"),
        { 
          theme: "outline", 
          size: "large", 
          width: "300",
          type: "standard"
        }
      );
    };

    function handleSignInResponse(response) {
      try {
        // Decode the JWT token to get user info
        const userInfo = parseJwt(response.credential);
        userCredential = response.credential;
        
        // Display user profile
        displayUserProfile(userInfo);
        
        const resultDiv = document.getElementById("result");
        resultDiv.className = "success";
        resultDiv.textContent = `✅ Signed in as ${userInfo.name}`;
        
      } catch (error) {
        const resultDiv = document.getElementById("result");
        resultDiv.className = "error";
        resultDiv.textContent = `❌ Sign-in error: ${error.message}`;
      }
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function displayUserProfile(userInfo) {
      document.getElementById("googleSignInButton").style.display = "none";
      document.getElementById("userProfile").classList.remove("hidden");
      document.getElementById("userName").textContent = userInfo.name;
      document.getElementById("userEmail").textContent = userInfo.email;
      document.getElementById("userPhoto").src = userInfo.picture;
    }

    function signOut() {
      google.accounts.id.disableAutoSelect();
      userCredential = null;
      
      // Reset UI
      document.getElementById("googleSignInButton").style.display = "block";
      document.getElementById("userProfile").classList.add("hidden");
      document.getElementById("dateSelector").classList.add("hidden");
      document.getElementById("noResponseSection").style.display = "none";
      document.getElementById("responseSection").style.display = "none";
      
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "";
      resultDiv.className = "";
    }

    async function verifyAccess() {
      if (!userCredential) {
        const resultDiv = document.getElementById("result");
        resultDiv.className = "error";
        resultDiv.textContent = "❌ Please sign in first";
        return;
      }
      
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "Verifying access permissions...";
      resultDiv.className = "info";

      try {
        const payload = { 
          userToken: userCredential, 
          action: "verifyAccess" 
        };
        
        const response = await fetch(scriptUrl + `?origin=${encodeURIComponent(window.location.origin)}`, {
          method: "POST",
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload),
          redirect: "follow"
        });
        const data = await response.json();

        if (data.ok) {
          // Get available sheets
          await getSheetNames();
        } else {
          throw new Error(data.error || "Access denied");
        }
      } catch (err) {
        resultDiv.className = "error";
        resultDiv.innerHTML = `❌ Error verifying access: ${err.message}<br><button class="btn" style="margin-top: 10px;" onclick="verifyAccess()">Retry</button>`;
      }
    }

    async function getSheetNames() {
      try {
        const payload = { 
          userToken: userCredential, 
          action: "getSheetNames" 
        };
        
        const response = await fetch(scriptUrl + `?origin=${encodeURIComponent(window.location.origin)}`, {
          method: "POST",
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload),
          redirect: "follow"
        });
        const data = await response.json();

        if (data.ok) {
          availableSheets = data.sheetNames;
          
          // Extract available dates from sheet names
          extractAvailableDates();
          setupDateLimits();

          const resultDiv = document.getElementById("result");
          resultDiv.className = "success";
          resultDiv.textContent = "✅ Access verified! Found " + availableSheets.length + " sheets.";

          // Hide the auth section with smooth transition and show the date selector
          const authSection = document.getElementById("authArea").parentElement;
          authSection.classList.add("fade-out");
          
          setTimeout(() => {
            authSection.style.display = "none";
            const dateSelector = document.getElementById("dateSelector");
            dateSelector.classList.remove("hidden");
            dateSelector.classList.add("fade-in");
          }, 300);
        } else {
          throw new Error(data.error || "Failed to get sheet names");
        }
      } catch (err) {
        const resultDiv = document.getElementById("result");
        resultDiv.className = "error";
        resultDiv.textContent = `❌ Error getting sheets: ${err.message}`;
      }
    }

        async function onDateSelected() {
      const selectedDate = document.getElementById("dateInput").value;
      
      if (!selectedDate) return;

      // jQuery datepicker already ensures only valid dates can be selected
      console.log('Selected date:', selectedDate);

      // Find the sheet name that starts with the selected date
      const sheetName = availableSheets.find(name => name.startsWith(selectedDate));
      if (sheetName) {
        await fetchSheetContent(sheetName);
      } else {
        const resultDiv = document.getElementById("result");
        resultDiv.className = "error";
        resultDiv.textContent = "❌ No sheet found for " + selectedDate;
      }
    }

    async function fetchSheetContent(sheetName) {
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "Fetching content for " + sheetName + "...";
      resultDiv.className = "info";

      showLoading();

      try {
        const payload = { 
          userToken: userCredential, 
          action: "getSheetContent", 
          sheetName 
        };
        const response = await fetch(scriptUrl + `?origin=${encodeURIComponent(window.location.origin)}`, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.ok) {
          // Work directly with 2D array from Sheets
          const rows = data.data;
          
          console.log("Raw data rows received:", rows.length);
          console.log("First few rows:", rows.slice(0, 3));
          
          parseSheetData(rows);
          analyzeData();
          displayResults();
          
          resultDiv.className = "success";
          resultDiv.textContent = `✅ Sheet processed successfully! Analyzed ${rawData.length} records.`;
        } else {
          throw new Error(data.error || "Failed to fetch content");
        }
      } catch (err) {
        resultDiv.className = "error";
        resultDiv.innerHTML = `❌ Error fetching content: ${err.message}<br><button class="btn" style="margin-top: 10px;" onclick="fetchSheetContent('${sheetName}')">Retry</button>`;
      } finally {
        hideLoading();
      }
    }

        function parseSheetData(rows) {
      if (!rows || rows.length < 2) {
        throw new Error('Sheet data appears to be empty or invalid');
      }

      // First row is headers
      const headers = rows[0].map(header => String(header).trim());
      console.log("Parsed headers:", headers);
      
      // Validate expected columns
      const expectedColumns = ['Brand', 'Fname', 'Lname', 'Number', 'Initial Send Time', 'Failed', 'Response', 'Response Time (Central)'];
      for (let col of expectedColumns) {
        if (!headers.includes(col)) {
          throw new Error(`Missing expected column: ${col}. Found columns: ${headers.join(', ')}`);
        }
      }

      rawData = [];
      let processedCount = 0;
      
      // Process data rows (skip header row)
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;
        
        try {
          const record = {};
          
          // Map each column value to its header
          headers.forEach((header, index) => {
            record[header] = String(row[index] || '').trim();
          });
          
          // Extract message columns
          record.messages = [];
          headers.forEach((header, index) => {
            if (header.startsWith('Message ')) {
              const messageText = String(row[index] || '').trim();
              if (messageText) {
                record.messages.push(messageText);
              }
            }
          });
          
          rawData.push(record);
          processedCount++;
          
          // Log first few records for debugging
          if (processedCount <= 3) {
            console.log(`Record ${processedCount}:`, record);
          }
        } catch (error) {
          console.error(`Error parsing row ${i}:`, error.message);
          console.error("Problematic row:", row);
        }
      }
      
      console.log(`Successfully parsed ${processedCount} records out of ${rows.length - 1} data rows`);
    }

    function analyzeData() {
      processedData = {
        noResponse: {
          BOOKING: 0,
          SCHEDULE: 0,
          RESERVE: 0,
          SESSIONS: 0
        },
        responses: {
          BOOKING: [],
          SCHEDULE: [],
          RESERVE: [],
          SESSIONS: []
        },
        stopResponses: {
          BOOKING: 0,
          SCHEDULE: 0,
          RESERVE: 0,
          SESSIONS: 0
        }
      };

      rawData.forEach(record => {
        const brand = record.Brand || 'Unknown';
        const hasResponse = record.Response === 'X';
        
        if (!processedData.noResponse[brand]) {
          processedData.noResponse[brand] = 0;
        }
        if (!processedData.responses[brand]) {
          processedData.responses[brand] = [];
        }
        if (!processedData.stopResponses[brand]) {
          processedData.stopResponses[brand] = 0;
        }

        if (hasResponse) {
          const messages = record.messages || [];
          
          // Check for STOP messages (only in incoming messages from customers)
          const hasStopMessage = messages.some(message => 
            message.includes('-> You:') && /\b(stop|STOP|Stop)\b/.test(message)
          );
          
          // Format name properly
          let displayName = 'No Name';
          const fname = record.Fname && record.Fname !== 'N/A' ? record.Fname.trim() : '';
          const lname = record.Lname && record.Lname !== 'N/A' ? record.Lname.trim() : '';
          
          if (fname && lname) {
            displayName = `${fname} ${lname}`;
          } else if (fname) {
            displayName = fname;
          } else if (lname) {
            displayName = lname;
          }

          const responseRecord = {
            name: displayName,
            phone: record.Number || 'N/A',
            responseTime: record['Response Time (Central)'] || 'N/A',
            initialSendTime: record['Initial Send Time'] || 'N/A',
            messages: messages,
            hasStopMessage: hasStopMessage
          };
          
          processedData.responses[brand].push(responseRecord);
          
          if (hasStopMessage) {
            processedData.stopResponses[brand]++;
          }
        } else {
          processedData.noResponse[brand]++;
        }
      });
    }

    function displayResults() {
      displayNoResponseStats();
      displayStopResponseStats();
      displayResponseSections();
      document.getElementById('noResponseSection').style.display = 'block';
      document.getElementById('responseSection').style.display = 'block';
    }

    function displayNoResponseStats() {
      const container = document.getElementById('noResponseStats');
      container.innerHTML = '';

      const table = document.createElement('table');
      
      // Add header
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <th>Brand</th>
        <th>No Response Count</th>
      `;
      table.appendChild(headerRow);

      // Add brand rows
      Object.entries(processedData.noResponse).forEach(([brand, count]) => {
        if (count > 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${brand}</td>
            <td class="number-cell">${count}</td>
          `;
          table.appendChild(row);
        }
      });

      // Add total row
      const total = Object.values(processedData.noResponse).reduce((sum, count) => sum + count, 0);
      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      totalRow.innerHTML = `
        <td>Total</td>
        <td class="number-cell">${total}</td>
      `;
      table.appendChild(totalRow);

      container.appendChild(table);
    }

    function displayStopResponseStats() {
      const container = document.getElementById('stopResponsesStats');
      container.innerHTML = '';

      const totalStopResponses = Object.values(processedData.stopResponses).reduce((sum, count) => sum + count, 0);
      
      if (totalStopResponses > 0) {
        const stopCard = document.createElement('div');
        stopCard.className = 'stat-card';
        stopCard.style.background = '#fff2f0';
        stopCard.style.borderColor = '#ffccc7';
        stopCard.innerHTML = `
          <div class="stat-number" style="color: #a8071a;">${totalStopResponses}</div>
          <div class="stat-label" style="color: #a8071a;">STOP Responses</div>
        `;
        container.appendChild(stopCard);
      }
    }

    function displayResponseSections() {
      const container = document.getElementById('responseBrands');
      container.innerHTML = '';

      // Update total responses count in header
      const totalResponses = Object.values(processedData.responses)
        .reduce((sum, records) => sum + records.length, 0);
      document.getElementById('totalResponsesCount').textContent = `${totalResponses} Total Responses`;

      Object.entries(processedData.responses).forEach(([brand, records]) => {
        if (records.length > 0) {
          const brandSection = createBrandSection(brand, records);
          container.appendChild(brandSection);
        }
      });
    }

    function createBrandSection(brand, records) {
      const section = document.createElement('div');
      section.className = 'brand-section';
      
      const header = document.createElement('div');
      header.className = 'brand-header';
      header.innerHTML = `
        <div class="brand-name">${brand}</div>
        <div class="brand-count">${records.length} responses</div>
        <div class="toggle-icon">▼</div>
      `;
      
      const content = document.createElement('div');
      content.className = 'brand-content';
      
      records.forEach(record => {
        const recordItem = createRecordItem(record);
        content.appendChild(recordItem);
      });
      
      header.addEventListener('click', () => {
        const isVisible = content.style.display === 'block';
        content.style.display = isVisible ? 'none' : 'block';
        const icon = header.querySelector('.toggle-icon');
        icon.classList.toggle('rotated', !isVisible);
      });
      
      section.appendChild(header);
      section.appendChild(content);
      
      return section;
    }

    function createRecordItem(record) {
      const item = document.createElement('div');
      item.className = 'record-item';
      
      const header = document.createElement('div');
      header.className = 'record-header';
      header.innerHTML = `
        <div class="record-info">
          <div class="record-name">${record.name}</div>
          <div class="record-phone">${record.phone}</div>
          <div class="record-time">Responded: ${record.responseTime}</div>
        </div>
        <div class="toggle-icon">▼</div>
      `;
      
      const messages = document.createElement('div');
      messages.className = 'record-messages';
      
      if (record.messages.length > 0) {
        record.messages.forEach(messageText => {
          const message = document.createElement('div');
          message.className = 'message';
          
          // Determine message direction
          if (messageText.includes('You ->:')) {
            message.classList.add('outgoing');
            messageText = messageText.replace('You ->:', '').trim();
            
            // Check for campaign follow-up messages
            if (messageText.includes('just following up on your interest in a newborn session') && 
                messageText.includes('Dates are booking quickly')) {
              message.style.background = '#fffef0';
              message.style.borderLeftColor = '#ffd700';
              message.style.color = '#b8860b';
            }
          } else if (messageText.includes('-> You:')) {
            message.classList.add('incoming');
            messageText = messageText.replace('-> You:', '').trim();
            
            // Highlight STOP messages (only actual customer STOP responses)
            if (/\b(stop|STOP|Stop)\b/.test(messageText) && !messageText.toLowerCase().includes('reply stop to unsubscribe')) {
              message.style.background = '#fff2f0';
              message.style.borderLeftColor = '#a8071a';
              message.style.color = '#a8071a';
            }
          }
          
          message.innerHTML = `<div class="message-text">${escapeHtml(messageText)}</div>`;
          messages.appendChild(message);
        });
      } else {
        messages.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No message history available</div>';
      }
      
      header.addEventListener('click', () => {
        const isVisible = messages.style.display === 'block';
        messages.style.display = isVisible ? 'none' : 'block';
        const icon = header.querySelector('.toggle-icon');
        icon.classList.toggle('rotated', !isVisible);
      });
      
      item.appendChild(header);
      item.appendChild(messages);
      
      return item;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingSection').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingSection').style.display = 'none';
    }

    // Control functions for expand/collapse
    function expandAllBrands() {
      document.querySelectorAll('.brand-content').forEach(content => {
        content.style.display = 'block';
        const icon = content.previousElementSibling.querySelector('.toggle-icon');
        icon.classList.add('rotated');
      });
    }

    function collapseAllBrands() {
      document.querySelectorAll('.brand-content').forEach(content => {
        content.style.display = 'none';
        const icon = content.previousElementSibling.querySelector('.toggle-icon');
        icon.classList.remove('rotated');
      });
    }

    function expandAllRecords() {
      document.querySelectorAll('.record-messages').forEach(messages => {
        messages.style.display = 'block';
        const icon = messages.previousElementSibling.querySelector('.toggle-icon');
        icon.classList.add('rotated');
      });
    }

    function collapseAllRecords() {
      document.querySelectorAll('.record-messages').forEach(messages => {
        messages.style.display = 'none';
        const icon = messages.previousElementSibling.querySelector('.toggle-icon');
        icon.classList.remove('rotated');
      });
    }

    // Date validation helper functions
    function extractAvailableDates() {
      availableDates = [];
      const datePattern = /^(\d{4}-\d{2}-\d{2})/;
      
      availableSheets.forEach(sheetName => {
        const match = sheetName.match(datePattern);
        if (match) {
          const date = match[1];
          if (!availableDates.includes(date)) {
            availableDates.push(date);
          }
        }
      });
      
      // Sort dates in descending order (newest first)
      availableDates.sort((a, b) => new Date(b) - new Date(a));
      console.log("Available dates extracted:", availableDates);
    }

    function setupDateLimits() {
      const availableDatesText = document.getElementById("availableDatesText");
      
      if (availableDates.length > 0) {
        // Convert available dates to Date objects for comparison
        const availableDateObjects = availableDates.map(dateStr => new Date(dateStr + 'T00:00:00'));
        
        // Initialize jQuery datepicker with beforeShowDay function
        $("#dateInput").datepicker({
          dateFormat: 'yy-mm-dd',
          beforeShowDay: function(date) {
            // Check if this date is in our available dates
            const dateString = date.getFullYear() + '-' + 
                             String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(date.getDate()).padStart(2, '0');
            
            const isAvailable = availableDates.includes(dateString);
            
            // Return [enabled, cssClass, tooltip]
            if (isAvailable) {
              return [true, 'available-date', 'Data available for this date'];
            } else {
              return [false, 'unavailable-date', 'No data available for this date'];
            }
          },
          onSelect: function(dateText) {
            // Call our existing function when a date is selected
            onDateSelected();
          },
          minDate: new Date(availableDates[availableDates.length - 1] + 'T00:00:00'), // oldest
          maxDate: new Date(availableDates[0] + 'T00:00:00') // newest
        });
        
        // Update the available dates text
        const formattedDates = availableDates.map(date => {
          const dateObj = new Date(date + 'T00:00:00');
          return dateObj.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
        }).join(', ');
        
        availableDatesText.textContent = formattedDates;
        
        console.log(`jQuery datepicker configured with available dates:`, availableDates);
      }
    }

    
  </script>
</body>
</html>