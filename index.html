<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heymarket Campaign Analysis Tool</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; color: white; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .header p { font-size: 1.2rem; }
    .card {
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    #result {
      margin-top: 20px; padding: 15px; border-radius: 4px;
      white-space: pre-wrap; font-family: monospace;
    }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Campaign Analysis</h1>
      <p>View reports directly from Google Sheets</p>
    </div>

    <div class="card">
      <!-- Step 1: Password -->
      <label for="passwordInput">Enter Password:</label>
      <input type="password" id="passwordInput" placeholder="Enter password">
      <button onclick="verifyPassword()">Verify</button>
    </div>

    <!-- Step 2: After password verified -->
    <div id="dateSelector" class="card hidden">
      <label for="dateInput">Select Date:</label>
      <input type="date" id="dateInput" onchange="onDateSelected()">
      <select id="dateDropdown" onchange="onDropdownSelected()"></select>
    </div>

    <!-- Where parseCSV results show -->
    <div id="result"></div>
  </div>

  <script>
    const Google_Script_ID = "AKfycbzfOem8exv5LUzaHPHjBbizCFEl4Mx700YLg4XgWwIqsOP1BwUMvyxdim2w2iEdMvYF";
    const scriptUrl = "https://script.google.com/macros/s/" + Google_Script_ID + "/exec";

    let verifiedSecret = null;
    let availableSheets = [];

    async function verifyPassword() {
      const password = document.getElementById("passwordInput").value.trim();
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "Verifying password...";
      resultDiv.className = "info";

      try {
        const payload = { secret: password, action: "getSheetNames" };
        const response = await fetch(scriptUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          redirect: "follow"
        });
        const data = await response.json();

        if (data.ok) {
          verifiedSecret = password;
          availableSheets = data.sheetNames;

          resultDiv.className = "success";
          resultDiv.textContent = "‚úÖ Password verified! Found " + availableSheets.length + " sheets.";

          const dropdown = document.getElementById("dateDropdown");
          dropdown.innerHTML = "<option value=''>-- Select a date --</option>";
          availableSheets.forEach(name => {
            dropdown.innerHTML += `<option value="${name}">${name}</option>`;
          });

          document.getElementById("dateSelector").classList.remove("hidden");
        } else {
          throw new Error(data.error || "Invalid password");
        }
      } catch (err) {
        resultDiv.className = "error";
        resultDiv.textContent = "‚ùå Error verifying password: " + err.message;
      }
    }

    async function onDropdownSelected() {
      const sheetName = document.getElementById("dateDropdown").value;
      if (sheetName) await fetchSheetContent(sheetName);
    }

    async function onDateSelected() {
      const selectedDate = document.getElementById("dateInput").value;
      if (!selectedDate) return;
      const sheetName = availableSheets.find(name => name.startsWith(selectedDate));
      if (sheetName) {
        document.getElementById("dateDropdown").value = sheetName;
        await fetchSheetContent(sheetName);
      } else {
        document.getElementById("result").className = "error";
        document.getElementById("result").textContent = "‚ùå No sheet found for " + selectedDate;
      }
    }

    async function fetchSheetContent(sheetName) {
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "Fetching content for " + sheetName + "...";
      resultDiv.className = "info";

      try {
        const payload = { secret: verifiedSecret, action: "getSheetContent", sheetName };
        const response = await fetch(scriptUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.ok) {
          // Convert 2D array from Sheets into CSV string
          const rows = data.data;
          const csvContent = rows.map(r =>
            r.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",")
          ).join("\n");

          // Reuse your existing CSV parsing pipeline
          parseCSV(csvContent);
          showSuccess("Sheet processed successfully!");
        } else {
          throw new Error(data.error || "Failed to fetch content");
        }
      } catch (err) {
        resultDiv.className = "error";
        resultDiv.textContent = "‚ùå Error fetching content: " + err.message;
      }
    }

    /* === Your existing CSV parser functions from old file === */
    let rawData = [];

    function parseCSV(csvContent) {
      const lines = csvContent.split('\n');
      if (lines.length < 2) throw new Error('CSV file appears to be empty or invalid');

      const headers = parseCSVLine(lines[0]);
      const expectedColumns = ['Brand','Fname','Lname','Number','Initial Send Time','Failed','Response','Response Time (Central)'];
      for (let col of expectedColumns) {
        if (!headers.includes(col)) throw new Error(`Missing expected column: ${col}`);
      }

      rawData = [];
      for (let i=1;i<lines.length;i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const values = parseCSVLine(line);
        if (values.length < headers.length) continue;
        const record = {};
        headers.forEach((header, idx) => record[header] = values[idx] || '');
        record.messages = [];
        for (let j=0;j<headers.length;j++) {
          if (headers[j].startsWith('Message ')) {
            const msg = values[j] || '';
            if (msg.trim()) record.messages.push(msg);
          }
        }
        rawData.push(record);
      }

      renderData(rawData);
    }

    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      for (let i=0;i<line.length;i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim()); current = '';
        } else current += char;
      }
      values.push(current.trim());
      return values;
    }

    function renderData(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.className = 'success';
      resultDiv.textContent = "‚úÖ Parsed " + data.length + " rows\n\n" + JSON.stringify(data.slice(0,5), null, 2);
    }

    function showSuccess(msg) {
      const resultDiv = document.getElementById('result');
      resultDiv.className = 'success';
      resultDiv.textContent = msg;
    }
  </script>
</body>
</html>
